{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} - الإمبراطور الخليجي{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-gray-600 mb-8">
        <a href="{% url 'store:product_list' %}" class="hover:text-primary">المنتجات</a>
        <span>‹</span>
        <a href="?category={{ product.category.slug }}" class="hover:text-primary">{{ product.category.name }}</a>
        <span>‹</span>
        <span class="text-gray-900">{{ product.name }}</span>
    </nav>

    <!-- Product Details Section -->
    <div class="bg-white rounded-lg shadow-sm p-6 md:p-8 mb-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            
            <!-- Product Images -->
            <div>
                <!-- Main Image -->
                <div class="mb-4 rounded-lg overflow-hidden border border-gray-200">
                    <img 
                        id="main-product-image"
                        src="{{ product.main_image.url }}" 
                        alt="{{ product.name }}"
                        class="w-full h-96 object-cover">
                </div>
                
                <!-- Thumbnail Gallery -->
                {% if product_images|length > 1 %}
                <div class="grid grid-cols-4 gap-2">
                    {% for image in product_images %}
                    <button 
                        onclick="document.getElementById('main-product-image').src='{{ image.url }}'"
                        class="rounded-lg overflow-hidden border-2 border-gray-200 hover:border-primary transition-colors">
                        <img src="{{ image.url }}" alt="{{ product.name }}" class="w-full h-20 object-cover">
                    </button>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <!-- Product Info -->
            <div>
                
                <!-- Badges -->
                <div class="flex flex-wrap gap-2 mb-4">
                    {% if product.is_new_arrival %}
                    <span class="bg-primary text-white text-xs font-semibold px-3 py-1 rounded-full">جديد</span>
                    {% endif %}
                    {% if product.is_featured %}
                    <span class="bg-yellow-500 text-white text-xs font-semibold px-3 py-1 rounded-full">مميز</span>
                    {% endif %}
                    {% if product.discount_percentage > 0 %}
                    <span class="bg-red-500 text-white text-xs font-semibold px-3 py-1 rounded-full">-{{ product.discount_percentage }}% تخفيض</span>
                    {% endif %}
                </div>
                
                <!-- Product Name -->
                <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ product.name }}</h1>
                
                <!-- Category & Brand -->
                <div class="flex items-center gap-4 text-sm text-gray-600 mb-4">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold">الفئة:</span>
                        <a href="?category={{ product.category.slug }}" class="text-primary hover:underline">{{ product.category.name }}</a>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-semibold">العلامة:</span>
                        <a href="?brand={{ product.brand.slug }}" class="text-primary hover:underline">{{ product.brand.name }}</a>
                    </div>
                </div>
                
                <!-- SKU -->
                <p class="text-sm text-gray-600 mb-6">
                    <span class="font-semibold">رمز المنتج:</span> {{ product.sku }}
                </p>
                
                <!-- Price -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-4xl font-bold text-primary">{{ product.final_price }}</span>
                        <span class="text-2xl text-gray-600">ر.س</span>
                        {% if product.sale_price %}
                        <span class="text-xl text-gray-500 line-through">{{ product.price }} ر.س</span>
                        {% endif %}
                    </div>
                    {% if product.sale_price %}
                    <p class="text-sm text-green-600 font-semibold">وفر {{ product.price|floatformat:2|add:"-"|add:product.sale_price|floatformat:2 }} ر.س</p>
                    {% endif %}
                </div>
                
                <!-- Stock Status (حالة المخزون) -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <p class="text-sm font-semibold text-gray-700 mb-2">حالة المخزون</p>
                    {% if product.stock == 0 %}
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-red-600 font-semibold">نفذت الكمية</span>
                        </div>
                    {% elif product.stock > 0 and product.stock <= product.inventory.low_stock_threshold %}
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-yellow-600 font-semibold">يتبقى {{ product.stock }} فقط!</span>
                        </div>
                    {% elif product.stock > product.inventory.low_stock_threshold %}
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-green-600 font-semibold">متوفر</span>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Add to Cart Form -->
                <div class="flex gap-3">
                    {% if product.has_stock %}
                    <form 
                        class="flex-1"
                        hx-post="{% url 'orders:add_to_cart' product.id %}" 
                        hx-target="#mini-cart" 
                        hx-swap="outerHTML">
                        {% csrf_token %}
                        <button 
                            type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-colors text-lg">
                            إضافة إلى السلة
                        </button>
                    </form>
                    {% else %}
                    <button 
                        disabled
                        class="flex-1 bg-gray-400 text-gray-600 font-bold py-4 px-6 rounded-lg cursor-not-allowed text-lg">
                        غير متوفر
                    </button>
                    {% endif %}
                </div>
                
            </div>
            
        </div>
    </div>

    <!-- Tabs Section -->
    <div class="bg-white rounded-lg shadow-sm p-6 md:p-8 mb-8">
        
        <!-- Tab Headers -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="flex gap-6">
                <button 
                    onclick="showTab('description')" 
                    id="tab-description"
                    class="tab-button border-b-2 border-blue-600 text-blue-600 pb-3 font-semibold">
                    الوصف
                </button>
                <button 
                    onclick="showTab('specifications')" 
                    id="tab-specifications"
                    class="tab-button border-b-2 border-transparent text-gray-600 hover:text-gray-900 pb-3 font-semibold">
                    المواصفات
                </button>
                {% if product.compatible_makes or product.compatible_models %}
                <button 
                    onclick="showTab('compatibility')" 
                    id="tab-compatibility"
                    class="tab-button border-b-2 border-transparent text-gray-600 hover:text-gray-900 pb-3 font-semibold">
                    التوافق
                </button>
                {% endif %}
            </nav>
        </div>
        
        <!-- Tab Content -->
        <div id="content-description" class="tab-content">
            <div class="prose prose-lg max-w-none">
                <p class="text-gray-700 leading-relaxed">{{ product.description|linebreaks }}</p>
            </div>
        </div>
        
        <div id="content-specifications" class="tab-content hidden">
            {% if product.specifications.all %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for spec in product.specifications.all %}
                <div class="flex justify-between items-center py-3 px-4 bg-gray-50 rounded-lg">
                    <span class="font-semibold text-gray-900">{{ spec.name }}</span>
                    <span class="text-gray-700">{{ spec.value }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-600">لا توجد مواصفات متاحة لهذا المنتج.</p>
            {% endif %}
        </div>
        
        {% if product.compatible_makes or product.compatible_models %}
        <div id="content-compatibility" class="tab-content hidden">
            <div class="space-y-4">
                {% if product.compatible_makes %}
                <div>
                    <h3 class="font-semibold text-gray-900 mb-2">الماركات المتوافقة:</h3>
                    <p class="text-gray-700">{{ product.compatible_makes }}</p>
                </div>
                {% endif %}
                {% if product.compatible_models %}
                <div>
                    <h3 class="font-semibold text-gray-900 mb-2">الموديلات المتوافقة:</h3>
                    <p class="text-gray-700">{{ product.compatible_models }}</p>
                </div>
                {% endif %}
                {% if product.year_from or product.year_to %}
                <div>
                    <h3 class="font-semibold text-gray-900 mb-2">السنوات:</h3>
                    <p class="text-gray-700">{{ product.year_from|default:"لا يوجد" }} - {{ product.year_to|default:"لا يوجد" }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
    </div>

    <!-- Reviews Section -->
    <div class="bg-white rounded-lg shadow-sm p-6 md:p-8 mb-8">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">آراء العملاء</h2>
            
            <!-- Average Rating Display -->
            {% if reviews %}
            <div class="flex items-center gap-4 mb-6">
                <div class="flex items-center gap-1">
                    {% for i in "12345" %}
                        {% if forloop.counter <= avg_rating %}
                        <svg class="w-6 h-6 text-yellow-400 fill-current" viewBox="0 0 20 20">
                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                        </svg>
                        {% else %}
                        <svg class="w-6 h-6 text-gray-300 fill-current" viewBox="0 0 20 20">
                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                        </svg>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="text-lg font-semibold text-gray-900">{{ avg_rating|floatformat:1 }}/5</span>
                <span class="text-gray-600">(من {{ reviews.count }} مراجعة)</span>
            </div>
            {% endif %}
        </div>

        <!-- Submit Review Form (for logged-in users) -->
        {% if user.is_authenticated %}
            {% if not user_has_reviewed %}
            <div class="bg-gray-50 rounded-lg p-6 mb-8 border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">أضف مراجعتك</h3>
                <form 
                    hx-post="{% url 'store:add_review' product.id %}" 
                    hx-target="#review-list" 
                    hx-swap="afterbegin"
                    hx-on::after-request="if(event.detail.successful) this.reset()">
                    {% csrf_token %}
                    
                    <!-- Rating Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">التقييم *</label>
                        <div class="flex gap-2" id="rating-stars">
                            {% for i in "12345" %}
                            <input type="radio" name="rating" value="{{ forloop.counter }}" id="star-{{ forloop.counter }}" class="hidden" required>
                            <label 
                                for="star-{{ forloop.counter }}" 
                                class="cursor-pointer transition-colors star-label">
                                <svg class="w-8 h-8 fill-current text-gray-300" viewBox="0 0 20 20">
                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                </svg>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Comment Textarea -->
                    <div class="mb-4">
                        <label for="comment" class="block text-sm font-medium text-gray-700 mb-2">مراجعتك *</label>
                        <textarea 
                            name="comment" 
                            id="comment" 
                            rows="4" 
                            required
                            placeholder="اكتب رأيك في المنتج..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"></textarea>
                    </div>
                    
                    <!-- Submit Button -->
                    <button 
                        type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        إرسال المراجعة
                    </button>
                </form>
            </div>
            {% else %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
                <p class="text-blue-800">لقد قمت بمراجعة هذا المنتج من قبل. شكراً لك!</p>
            </div>
            {% endif %}
        {% else %}
        <div class="bg-gray-50 rounded-lg p-6 mb-8 border border-gray-200 text-center">
            <p class="text-gray-700 mb-3">يجب تسجيل الدخول لإضافة مراجعة</p>
            <a href="{% url 'users:login' %}?next={{ request.path }}" class="inline-block bg-primary hover:bg-primary/90 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                تسجيل الدخول
            </a>
        </div>
        {% endif %}

        <!-- Customer Reviews List -->
        <div>
            <h3 class="text-lg font-semibold text-gray-900 mb-4">جميع المراجعات</h3>
            <div id="review-list" class="space-y-4">
                {% for review in reviews %}
                    {% include 'store/partials/review_item.html' with review=review %}
                {% empty %}
                <div class="text-center py-8 text-gray-500">
                    <p>لا توجد مراجعات بعد. كن أول من يراجع هذا المنتج!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">منتجات مشابهة</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for related in related_products %}
            <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow overflow-hidden">
                <a href="{% url 'store:product_detail' related.slug %}" class="block">
                    <img src="{{ related.main_image.url }}" alt="{{ related.name }}" class="w-full h-48 object-cover">
                </a>
                <div class="p-4">
                    <a href="{% url 'store:product_detail' related.slug %}" class="block font-semibold text-gray-900 hover:text-primary mb-2 line-clamp-2">
                        {{ related.name }}
                    </a>
                    <div class="flex items-center gap-2">
                        <span class="text-lg font-bold text-primary">{{ related.final_price }} ر.س</span>
                        {% if related.sale_price %}
                        <span class="text-sm text-gray-500 line-through">{{ related.price }} ر.س</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<script>
function showTab(tabName) {
    // Hide all content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active state from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-blue-600', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-600');
    });
    
    // Show selected content
    document.getElementById('content-' + tabName).classList.remove('hidden');
    
    // Add active state to selected button
    const activeButton = document.getElementById('tab-' + tabName);
    activeButton.classList.add('border-blue-600', 'text-blue-600');
    activeButton.classList.remove('border-transparent', 'text-gray-600');
}

// Star rating functionality
document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('.star-label');
    const inputs = document.querySelectorAll('input[name="rating"]');
    
    stars.forEach((star, index) => {
        star.addEventListener('click', function() {
            // Update all stars up to clicked one
            stars.forEach((s, i) => {
                const svg = s.querySelector('svg');
                if (i <= index) {
                    svg.classList.remove('text-gray-300');
                    svg.classList.add('text-yellow-400');
                } else {
                    svg.classList.remove('text-yellow-400');
                    svg.classList.add('text-gray-300');
                }
            });
        });
        
        star.addEventListener('mouseenter', function() {
            // Highlight stars on hover
            stars.forEach((s, i) => {
                const svg = s.querySelector('svg');
                if (i <= index) {
                    svg.classList.add('text-yellow-300');
                }
            });
        });
        
        star.addEventListener('mouseleave', function() {
            // Remove hover effect
            stars.forEach((s) => {
                const svg = s.querySelector('svg');
                svg.classList.remove('text-yellow-300');
            });
        });
    });
});
</script>
{% endblock %}